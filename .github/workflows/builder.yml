name: Build ESP32 bara.cpp

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    name: Build Firmware
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Cache PlatformIO
        uses: actions/cache@v3
        with:
          path: |
            ~/.platformio
            ~/.cache/pip
          key: ${{ runner.os }}-pio

      - name: Install PlatformIO
        run: |
          pip install --upgrade platformio
          pio --version

      - name: Create Project Structure
        run: |
          mkdir -p src
          cp bara.cpp src/main.cpp

      - name: Fix Header Files
        run: |
          # Fix ESPAsyncWebSrv.h to ESPAsyncWebServer.h
          sed -i 's/ESPAsyncWebSrv\.h/ESPAsyncWebServer.h/g' src/main.cpp
          
          # Remove conflicting includes
          sed -i '/^#include <WebServer\.h>/d' src/main.cpp
          sed -i '/^#include <DNSServer\.h>/d' src/main.cpp
          sed -i '/^#include <WiFiManager\.h>/d' src/main.cpp
          
          # Remove duplicate FS.h
          awk '!seen[$0]++' src/main.cpp > src/main.tmp
          mv src/main.tmp src/main.cpp
          
          echo "✅ Headers fixed"
          grep -n "include" src/main.cpp | head -20

      - name: Fix Handler Functions
        run: |
          # Fix server.on() to work with AsyncWebServer
          # AsyncWebServer uses different syntax
          cat > fix_handlers.py << 'PYEOF'
import re

with open('src/main.cpp', 'r') as f:
    content = f.read()

# Fix handleRoot() to work with AsyncWebServer
content = re.sub(
    r'void handleRoot\(\) \{',
    r'void handleRoot(AsyncWebServerRequest *request) {',
    content
)

# Fix server.send() to request->send()
content = re.sub(
    r'server\.send\(200, "text/html", html\);',
    r'request->send(200, "text/html", html);',
    content
)

# Fix other server.send() calls
content = re.sub(
    r'server\.send\((\d+), "([^"]+)", ([^)]+)\);',
    r'request->send(\1, "\2", \3);',
    content
)

# Fix handleAPI
content = re.sub(
    r'void handleAPI\(\) \{',
    r'void handleAPI(AsyncWebServerRequest *request) {',
    content
)

# Fix server.hasArg to request->hasArg
content = re.sub(r'server\.hasArg', r'request->hasArg', content)
content = re.sub(r'server\.arg', r'request->arg', content)

# Fix sendHeader
content = re.sub(
    r'server\.sendHeader',
    r'request->sendHeader',
    content
)

with open('src/main.cpp', 'w') as f:
    f.write(content)

print("✅ Handler functions fixed for AsyncWebServer")
PYEOF

          python3 fix_handlers.py

      - name: Fix Server Registration
        run: |
          # Fix server.on() registration for AsyncWebServer
          sed -i 's/server\.on("\/", handleRoot);/server.on("\/", HTTP_GET, handleRoot);/g' src/main.cpp
          sed -i 's/server\.on("\/api", handleAPI);/server.on("\/api", HTTP_GET, handleAPI);/g' src/main.cpp
          
          # Fix server.onNotFound
          cat >> src/main.cpp.patch << 'EOF'
--- a/main.cpp
+++ b/main.cpp
@@ -1,1 +1,1 @@
-  server.onNotFound([]() {
+  server.onNotFound([](AsyncWebServerRequest *request) {
EOF
          
          sed -i 's/server\.onNotFound(\[\]() {/server.onNotFound([](AsyncWebServerRequest *request) {/g' src/main.cpp
          sed -i 's/server\.send(404,/request->send(404,/g' src/main.cpp
          
          echo "✅ Server registration fixed"

      - name: Create platformio.ini
        run: |
          cat > platformio.ini << 'EOF'
          [env:esp32dev]
          platform = espressif32
          board = esp32dev
          framework = arduino
          monitor_speed = 115200
          upload_speed = 921600
          board_build.filesystem = spiffs
          
          lib_deps = 
              bblanchon/ArduinoJson@^6.21.3
              https://github.com/me-no-dev/ESPAsyncWebServer.git
              https://github.com/me-no-dev/AsyncTCP.git
              https://github.com/tzapu/WiFiManager.git
          
          build_flags = 
              -DCORE_DEBUG_LEVEL=1
              -DBOARD_HAS_PSRAM
          EOF

      - name: Build Firmware
        run: pio run

      - name: Install esptool
        run: pip install esptool

      - name: Create Merged Binary
        run: |
          # Define paths
          FIRMWARE=".pio/build/esp32dev/firmware.bin"
          BOOTLOADER="~/.platformio/packages/framework-arduinoespressif32/tools/sdk/esp32/bin/bootloader_dio_40m.bin"
          PARTITIONS=".pio/build/esp32dev/partitions.bin"
          BOOT_APP0="~/.platformio/packages/framework-arduinoespressif32/tools/partitions/boot_app0.bin"
          
          # Expand paths
          BOOTLOADER=$(eval echo $BOOTLOADER)
          BOOT_APP0=$(eval echo $BOOT_APP0)
          
          # Create merged binary
          python -m esptool \
            --chip esp32 \
            merge_bin \
            -o bara_merged_0x0.bin \
            --flash_mode dio \
            --flash_freq 40m \
            --flash_size 4MB \
            0x1000 "$BOOTLOADER" \
            0x8000 "$PARTITIONS" \
            0xe000 "$BOOT_APP0" \
            0x10000 "$FIRMWARE"
          
          echo "✅ Merged binary created successfully!"
          ls -lh bara_merged_0x0.bin

      - name: Create Flash Instructions
        run: |
          cat > FLASH_INSTRUCTIONS.txt << 'EOF'
          ════════════════════════════════════════════════════
                  bara.cpp - Flash Instructions
          ════════════════════════════════════════════════════
          
          Method 1: Using esptool (Recommended)
          ────────────────────────────────────────────────
          esptool.py --chip esp32 --port COM3 --baud 921600 write_flash 0x0 bara_merged_0x0.bin
          
          For Linux/Mac:
          esptool.py --chip esp32 --port /dev/ttyUSB0 --baud 921600 write_flash 0x0 bara_merged_0x0.bin
          
          Method 2: Using ESP Flash Download Tool
          ────────────────────────────────────────────────
          1. Open ESP Flash Download Tool
          2. Select ESP32
          3. Add bara_merged_0x0.bin at address 0x0
          4. Click START
          
          Connection Info:
          ────────────────────────────────────────────────
          WiFi SSID: bara
          Password: A7med@Elshab7
          Web Interface: http://192.168.4.1
          
          ════════════════════════════════════════════════════
          EOF

      - name: Upload Merged Binary
        uses: actions/upload-artifact@v4
        with:
          name: bara-firmware
          path: |
            bara_merged_0x0.bin
            FLASH_INSTRUCTIONS.txt

      - name: Create Release
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v1.0.${{ github.run_number }}
          name: bara.cpp v1.0.${{ github.run_number }}
          body: |
            ## bara.cpp - ESP32 WiFi Security Tool
            
            ### Flash Command:
            ```bash
            esptool.py --chip esp32 --port COM3 write_flash 0x0 bara_merged_0x0.bin
            ```
            
            ### What's Included:
            - ✅ Merged binary ready to flash at 0x0
            - ✅ Complete flash instructions
            - ✅ Tested on ESP32 Dev Module
            
            **⚠️ Educational Use Only**
          files: |
            bara_merged_0x0.bin
            FLASH_INSTRUCTIONS.txt
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
