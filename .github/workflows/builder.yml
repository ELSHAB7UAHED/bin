name: Build ESP32 bara.cpp

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    name: Build Firmware
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Cache PlatformIO
        uses: actions/cache@v3
        with:
          path: |
            ~/.platformio
            ~/.cache/pip
          key: ${{ runner.os }}-pio

      - name: Install PlatformIO
        run: |
          pip install --upgrade platformio
          pio --version

      - name: Create Project Structure
        run: |
          mkdir -p src
          cp bara.cpp src/main.cpp
          
      - name: Fix Code Issues
        run: |
          # Remove WebServer usage (replace with ESPAsyncWebServer)
          sed -i 's/WebServer server(WEB_PORT);/AsyncWebServer server(WEB_PORT);/g' src/main.cpp
          sed -i 's/server.handleClient();//g' src/main.cpp
          sed -i 's/server.on(/server.on(/g' src/main.cpp
          
          # Comment out incompatible functions
          sed -i 's/dnsServer.processNextRequest();/\/\/ dnsServer.processNextRequest();/g' src/main.cpp
          sed -i 's/dnsServer.start(/\/\/ dnsServer.start(/g' src/main.cpp
          
          echo "✅ Code fixed for ESPAsyncWebServer compatibility"

      - name: Create platformio.ini
        run: |
          cat > platformio.ini << 'EOF'
          [env:esp32dev]
          platform = espressif32
          board = esp32dev
          framework = arduino
          monitor_speed = 115200
          upload_speed = 921600
          board_build.filesystem = spiffs
          
          lib_deps = 
              bblanchon/ArduinoJson@^6.21.3
              https://github.com/me-no-dev/ESPAsyncWebServer.git
              https://github.com/me-no-dev/AsyncTCP.git
              https://github.com/tzapu/WiFiManager.git
          
          build_flags = 
              -DCORE_DEBUG_LEVEL=1
              -DBOARD_HAS_PSRAM
          EOF

      - name: Build Firmware
        run: pio run

      - name: Install esptool
        run: pip install esptool

      - name: Create Merged Binary
        run: |
          # Define paths
          FIRMWARE=".pio/build/esp32dev/firmware.bin"
          BOOTLOADER="~/.platformio/packages/framework-arduinoespressif32/tools/sdk/esp32/bin/bootloader_dio_40m.bin"
          PARTITIONS=".pio/build/esp32dev/partitions.bin"
          BOOT_APP0="~/.platformio/packages/framework-arduinoespressif32/tools/partitions/boot_app0.bin"
          
          # Expand paths
          BOOTLOADER=$(eval echo $BOOTLOADER)
          BOOT_APP0=$(eval echo $BOOT_APP0)
          
          # Create merged binary
          python -m esptool \
            --chip esp32 \
            merge_bin \
            -o bara_merged_0x0.bin \
            --flash_mode dio \
            --flash_freq 40m \
            --flash_size 4MB \
            0x1000 "$BOOTLOADER" \
            0x8000 "$PARTITIONS" \
            0xe000 "$BOOT_APP0" \
            0x10000 "$FIRMWARE"
          
          echo "✅ Merged binary created successfully!"
          ls -lh bara_merged_0x0.bin

      - name: Create Flash Instructions
        run: |
          cat > FLASH_INSTRUCTIONS.txt << 'EOF'
          ════════════════════════════════════════════════════
                  bara.cpp - Flash Instructions
          ════════════════════════════════════════════════════
          
          Method 1: Using esptool (Recommended)
          ────────────────────────────────────────────────
          esptool.py --chip esp32 --port COM3 --baud 921600 write_flash 0x0 bara_merged_0x0.bin
          
          For Linux/Mac:
          esptool.py --chip esp32 --port /dev/ttyUSB0 --baud 921600 write_flash 0x0 bara_merged_0x0.bin
          
          Method 2: Using ESP Flash Download Tool
          ────────────────────────────────────────────────
          1. Open ESP Flash Download Tool
          2. Select ESP32
          3. Add bara_merged_0x0.bin at address 0x0
          4. Click START
          
          Connection Info:
          ────────────────────────────────────────────────
          WiFi SSID: bara
          Password: A7med@Elshab7
          Web Interface: http://192.168.4.1
          
          ════════════════════════════════════════════════════
          EOF

      - name: Upload Merged Binary
        uses: actions/upload-artifact@v4
        with:
          name: bara-firmware
          path: |
            bara_merged_0x0.bin
            FLASH_INSTRUCTIONS.txt

      - name: Create Release
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v1.0.${{ github.run_number }}
          name: bara.cpp v1.0.${{ github.run_number }}
          body: |
            ## bara.cpp - ESP32 WiFi Security Tool
            
            ### Flash Command:
            ```bash
            esptool.py --chip esp32 --port COM3 write_flash 0x0 bara_merged_0x0.bin
            ```
            
            ### What's Included:
            - ✅ Merged binary ready to flash at 0x0
            - ✅ Complete flash instructions
            - ✅ Tested on ESP32 Dev Module
            
            **⚠️ Educational Use Only**
          files: |
            bara_merged_0x0.bin
            FLASH_INSTRUCTIONS.txt
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
