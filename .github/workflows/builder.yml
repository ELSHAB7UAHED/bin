name: ESP32 bara.cpp Build and Release

on:
  push:
    tags: [ 'v*.*.*' ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:
    inputs:
      version:
        description: 'Firmware Version'
        required: true
        default: '1.0.0'

env:
  ARDUINO_CLI_VERSION: "0.35.0"
  ESP32_CORE_VERSION: "2.0.14"
  PROJECT_NAME: "bara-esp32-wifi-security"
  BUILD_VERSION: ${{ github.event.inputs.version || github.ref_name }}

jobs:
  build-esp32:
    name: Build ESP32 Firmware
    runs-on: ubuntu-22.04
    
    strategy:
      matrix:
        board: [ esp32dev, esp32doit-devkit-v1, nodemcu-32s ]
        include:
          - board: esp32dev
            description: "ESP32 Dev Module"
            flash_size: "4MB"
            partition_scheme: "default"
          - board: esp32doit-devkit-v1
            description: "DOIT ESP32 DevKit V1"
            flash_size: "4MB"
            partition_scheme: "default"
          - board: nodemcu-32s
            description: "NodeMCU-32S"
            flash_size: "4MB"
            partition_scheme: "default"
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 1
        submodules: recursive

    - name: Setup Arduino CLI
      run: |
        curl -fsSL https://raw.githubusercontent.com/arduino/arduino-cli/master/install.sh | sh
        echo "$(pwd)/bin" >> $GITHUB_PATH

    - name: Configure Arduino CLI
      run: |
        arduino-cli config init --overwrite
        arduino-cli config set board_manager.additional_urls https://raw.githubusercontent.com/espressif/arduino-esp32/gh-pages/package_esp32_index.json
        arduino-cli core update-index

    - name: Install ESP32 Arduino Core
      run: |
        arduino-cli core install esp32:esp32@${{ env.ESP32_CORE_VERSION }}

    - name: Install Required Libraries
      run: |
        arduino-cli lib install "ArduinoJson@6.21.3"
        arduino-cli lib install "WebServer@1.0.0"
        arduino-cli lib install "ESP Async WebServer@1.2.3"
        arduino-cli lib install "AsyncTCP@1.1.1"
        arduino-cli lib install "SPIFFS@1.0.0"
        arduino-cli lib install "WiFiManager@2.0.16-alpha"
        arduino-cli lib install "Ticker@3.1.0"
        arduino-cli lib install "FS@1.0.0"
        arduino-cli lib install "DNSServer@1.1.1"

    - name: Create Project Structure
      run: |
        mkdir -p ${{ env.PROJECT_NAME }}/src
        mkdir -p ${{ env.PROJECT_NAME }}/include
        mkdir -p ${{ env.PROJECT_NAME }}/data
        cp bara.cpp ${{ env.PROJECT_NAME }}/src/
        
        # Create platformio.ini configuration
        cat > ${{ env.PROJECT_NAME }}/platformio.ini << EOF
        [env:${{ matrix.board }}]
        platform = espressif32
        board = ${{ matrix.board }}
        framework = arduino
        monitor_speed = 115200
        upload_speed = 921600
        board_build.flash_mode = dio
        board_build.partitions = ${{ matrix.partition_scheme }}
        
        build_flags = 
            -D PROJECT_NAME="${{ env.PROJECT_NAME }}"
            -D PROJECT_VERSION="${{ env.BUILD_VERSION }}"
            -D ARDUINOJSON_USE_LONG_LONG=1
            -D ARDUINOJSON_ENABLE_PROGMEM=1
            -D ASYNC_TCP_SSL_ENABLED=0
        
        lib_deps = 
            bblanchon/ArduinoJson@6.21.3
            links2004/WebServer@1.0.0
            me-no-dev/ESP Async WebServer@1.2.3
            me-no-dev/AsyncTCP@1.1.1
            me-no-dev/SPIFFS@1.0.0
            tzapu/WiFiManager@2.0.16-alpha
            bertmelis/Ticker@3.1.0
            espressif/FS@1.0.0
            espressif/DNSServer@1.1.1
        
        upload_port = /dev/ttyUSB0
        EOF

    - name: Create PlatformIO Project File
      run: |
        cat > ${{ env.PROJECT_NAME }}/src/main.cpp << 'EOF'
        /*
         * bara.cpp - ESP32 WiFi Security Testing Tool
         * Created by: Ø£Ø­Ù…Ø¯ Ù†ÙˆØ± Ø£Ø­Ù…Ø¯ Ù…Ù† Ù‚Ù†Ø§
         * Platform: ESP32
         * Interface: English
         * Purpose: Educational WiFi Security Testing & Analysis
         * 
         * Legal Notice: This tool is for educational purposes only.
         * Always ensure proper authorization before testing any networks.
         * Unauthorized access is illegal and unethical.
         */
        
        #include <Arduino.h>
        #include <WiFi.h>
        #include <WebServer.h>
        #include <ArduinoJson.h>
        #include <ESPAsyncWebSrv.h>
        #include <SPIFFS.h>
        #include <FS.h>
        #include <DNSServer.h>
        #include <WiFiManager.h>
        #include <Ticker.h>
        
        // Auto-generated version info
        const char* PROJECT_VERSION = "${{ env.BUILD_VERSION }}";
        const char* PROJECT_BUILD_DATE = __DATE__ " " __TIME__;
        
        // [Rest of your existing code remains exactly the same]
        // Configuration
        const char* AP_NAME = "bara";
        const char* AP_PASSWORD = "A7med@Elshab7";
        const char* ADMIN_PASSWORD = "admin123";
        const int WEB_PORT = 80;
        const int SCAN_INTERVAL = 5000; // 5 seconds
        const int MAX_NETWORKS = 50;
        
        // [Continue with all your existing code...]
        EOF
        
        # Append the rest of your original code
        tail -n +20 bara.cpp >> ${{ env.PROJECT_NAME }}/src/main.cpp

    - name: Install PlatformIO Core
      run: |
        python -m pip install --upgrade platformio
        pio --version

    - name: Build with PlatformIO
      run: |
        cd ${{ env.PROJECT_NAME }}
        pio run -e ${{ matrix.board }}

    - name: Generate Merged Firmware Binary
      run: |
        cd ${{ env.PROJECT_NAME }}
        python -c "
        import os
        board = '${{ matrix.board }}'
        
        # Find the firmware binary
        firmware_path = f'.pio/build/{board}/firmware.bin'
        bootloader_path = f'.pio/build/{board}/bootloader.bin'
        partitions_path = f'.pio/build/{board}/partitions.bin'
        
        if os.path.exists(firmware_path):
            # Create merged binary using esptool
            merge_cmd = f'esptool.py --chip esp32 merge_bin -o merged_firmware_${{ env.BUILD_VERSION }}_{board}.bin 0x1000 {bootloader_path} 0x8000 {partitions_path} 0x10000 {firmware_path}'
            os.system(merge_cmd)
            print(f'âœ“ Merged firmware created for {board}')
        else:
            print(f'âœ— Firmware not found for {board}')
        "

    - name: Collect Build Artifacts
      run: |
        cd ${{ env.PROJECT_NAME }}
        mkdir -p artifacts/${{ matrix.board }}
        
        # Copy all relevant build files
        cp .pio/build/${{ matrix.board }}/*.bin artifacts/${{ matrix.board }}/
        cp merged_firmware_${{ env.BUILD_VERSION }}_${{ matrix.board }}.bin artifacts/${{ matrix.board }}/
        
        # Create build info file
        cat > artifacts/${{ matrix.board }}/build_info.txt << EOF
        Project: ${{ env.PROJECT_NAME }}
        Version: ${{ env.BUILD_VERSION }}
        Board: ${{ matrix.board }}
        Description: ${{ matrix.description }}
        Flash Size: ${{ matrix.flash_size }}
        Partition Scheme: ${{ matrix.partition_scheme }}
        Build Date: $(date -u)
        GitHub Run ID: ${{ github.run_id }}
        Commit: ${{ github.sha }}
        EOF

    - name: Upload Build Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: firmware-${{ matrix.board }}-${{ env.BUILD_VERSION }}
        path: ${{ env.PROJECT_NAME }}/artifacts/${{ matrix.board }}/
        retention-days: 30

  release:
    name: Create Release
    needs: build-esp32
    if: startsWith(github.ref, 'refs/tags/')
    runs-on: ubuntu-22.04
    
    steps:
    - name: Download All Artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts

    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          artifacts/**/*.bin
          artifacts/**/build_info.txt
        body: |
          # bara.cpp - ESP32 WiFi Security Testing Tool
          
          ## ðŸš€ Firmware Release ${{ env.BUILD_VERSION }}
          
          ### ðŸ“‹ Project Information
          - **Developer**: Ø£Ø­Ù…Ø¯ Ù†ÙˆØ± Ø£Ø­Ù…Ø¯ Ù…Ù† Ù‚Ù†Ø§
          - **Platform**: ESP32
          - **Purpose**: Educational WiFi Security Testing & Analysis
          
          ### âš ï¸ Legal Notice
          > This tool is for **EDUCATIONAL PURPOSES ONLY**.
          > Always ensure proper authorization before testing any networks.
          > Unauthorized access is illegal and unethical.
          
          ### ðŸ”§ Supported Boards
          - ESP32 Dev Module
          - DOIT ESP32 DevKit V1
          - NodeMCU-32S
          
          ### ðŸ“ Files Included
          - `merged_firmware_*.bin` - Complete firmware with offset 0x0
          - `firmware.bin` - Application firmware only
          - `bootloader.bin` - Bootloader
          - `partitions.bin` - Partition table
          
          ### ðŸ› ï¸ Flashing Instructions
          ```bash
          # Using esptool.py
          esptool.py --chip esp32 --port /dev/ttyUSB0 write_flash 0x0 merged_firmware_${{ env.BUILD_VERSION }}_esp32dev.bin
          
          # Using Arduino IDE
          # Select board and upload the merged binary
          ```
          
          ### ðŸ”’ Security Features
          - WiFi Network Scanning & Analysis
          - Signal Strength Monitoring
          - Security Type Detection
          - Educational Security Testing
          
          ### ðŸ“Š Build Information
          - Build Date: ${{ fromJSON(needs.build-esp32.outputs.build_date) }}
          - Core Version: ${{ env.ESP32_CORE_VERSION }}
          - Arduino CLI: ${{ env.ARDUINO_CLI_VERSION }}
          
          ---
          *For educational and authorized testing only.*
        draft: false
        prerelease: false
        generate_release_notes: true

  security-scan:
    name: Security Scan
    runs-on: ubuntu-22.04
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Run CodeQL Analysis
      uses: github/codeql-action/analyze@v3
      with:
        languages: 'cpp'

    - name: Semgrep Scan
      uses: returntocorp/semgrep-action@v1
      with:
        config: p/security-audit

  documentation:
    name: Generate Documentation
    runs-on: ubuntu-22.04
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    - name: Generate Documentation
      run: |
        mkdir -p docs
        cat > docs/README.md << 'EOF'
        # bara.cpp - ESP32 WiFi Security Testing Tool
        
        ## ðŸ“– Overview
        Advanced WiFi security analysis tool for ESP32 microcontrollers designed for educational purposes.
        
        ## âš ï¸ Legal Disclaimer
        **THIS TOOL IS FOR EDUCATIONAL AND AUTHORIZED SECURITY TESTING ONLY.**
        
        ## ðŸš€ Features
        - Real-time WiFi network scanning
        - Security type detection (WEP, WPA, WPA2, WPA3)
        - Signal strength analysis
        - Web-based management interface
        - Educational security testing capabilities
        
        ## ðŸ”§ Installation
        ### Prerequisites
        - ESP32 Development Board
        - Arduino IDE or PlatformIO
        - Required Libraries (see platformio.ini)
        
        ### Flashing Instructions
        ```bash
        # Using esptool
        esptool.py --chip esp32 --port /dev/ttyUSB0 write_flash 0x0 merged_firmware.bin
        ```
        
        ## ðŸ“Š Usage
        1. Flash the firmware to your ESP32
        2. Connect to "bara" access point
        3. Open web browser to access management interface
        4. Use tools responsibly and legally
        
        ## ðŸ›¡ï¸ Security Notes
        - Default AP Password: A7med@Elshab7
        - Admin Password: admin123
        - Change passwords in production environments
        
        ## ðŸ‘¨â€ðŸ’» Developer
        Ø£Ø­Ù…Ø¯ Ù†ÙˆØ± Ø£Ø­Ù…Ø¯ Ù…Ù† Ù‚Ù†Ø§
        
        ## ðŸ“„ License
        Educational Use Only
        EOF

    - name: Upload Documentation
      uses: actions/upload-artifact@v4
      with:
        name: documentation
        path: docs/
        retention-days: 30
