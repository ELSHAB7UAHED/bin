name: Build ESP32 bara.cpp Firmware

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

env:
  PROJECT_NAME: "bara-esp32"
  BUILD_VERSION: "1.0.0"

jobs:
  build:
    name: Build ESP32 Firmware
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.x'

    - name: Install PlatformIO
      run: |
        python -m pip install --upgrade platformio
        pio --version

    - name: Create PlatformIO Project
      run: |
        # Create project directory structure
        mkdir -p ${{ env.PROJECT_NAME }}/src
        
        # Copy main source file
        cp bara.cpp ${{ env.PROJECT_NAME }}/src/main.cpp
        
        # Create platformio.ini with SYNCHRONOUS WebServer only (no async)
        cat > ${{ env.PROJECT_NAME }}/platformio.ini << 'EOF'
        [env:esp32dev]
        platform = espressif32
        board = esp32dev
        framework = arduino
        monitor_speed = 115200
        upload_speed = 921600
        
        build_flags = 
            -D PROJECT_NAME="${{ env.PROJECT_NAME }}"
            -D PROJECT_VERSION="${{ env.BUILD_VERSION }}"
            -Wno-deprecated-declarations
        
        lib_deps = 
            bblanchon/ArduinoJson
            WebServer
            WiFiManager
        
        upload_port = /dev/ttyUSB0
        EOF

    - name: Modify Source Code for Synchronous WebServer
      run: |
        cd ${{ env.PROJECT_NAME }}/src
        
        # Replace all AsyncWebServer includes and code with synchronous WebServer
        sed -i 's/#include <ESPAsyncWebSrv.h>/#include <WebServer.h>/g' main.cpp
        sed -i 's/#include <AsyncWebSocket.h>//g' main.cpp
        sed -i 's/AsyncWebServer/WebServer/g' main.cpp
        sed -i 's/AsyncWebSocket/WebSocket/g' main.cpp
        sed -i 's/AsyncWebSocketClient/WebSocketClient/g' main.cpp
        sed -i 's/AsyncEventSource/EventSource/g' main.cpp
        
        # Remove WebSocket related code
        sed -i '/ws.onEvent/d' main.cpp
        sed -i '/server.addHandler.*ws/d' main.cpp
        sed -i '/AsyncWebSocketClient/d' main.cpp
        
        echo "âœ… Converted to synchronous WebServer successfully"

    - name: Build Firmware
      run: |
        cd ${{ env.PROJECT_NAME }}
        pio run

    - name: Create Merged Binary
      run: |
        cd ${{ env.PROJECT_NAME }}
        
        # Install esptool if not available
        python -m pip install esptool
        
        # Create merged firmware with correct offsets
        esptool.py --chip esp32 \
          merge_bin -o merged_firmware.bin \
          0x1000 .pio/build/esp32dev/bootloader.bin \
          0x8000 .pio/build/esp32dev/partitions.bin \
          0x10000 .pio/build/esp32dev/firmware.bin
        
        echo "âœ… Merged firmware created: merged_firmware.bin"

    - name: Collect Build Artifacts
      run: |
        cd ${{ env.PROJECT_NAME }}
        mkdir -p artifacts
        
        # Copy all binary files
        cp .pio/build/esp32dev/firmware.bin artifacts/
        cp .pio/build/esp32dev/bootloader.bin artifacts/
        cp .pio/build/esp32dev/partitions.bin artifacts/
        cp merged_firmware.bin artifacts/
        
        # Create flash instructions
        cat > artifacts/flash_instructions.txt << 'EOF'
        Flash Instructions for ESP32:
        
        1. Using esptool.py (Recommended):
           esptool.py --chip esp32 --port /dev/ttyUSB0 write_flash 0x0 merged_firmware.bin
        
        2. Using PlatformIO:
           pio run --target upload
        
        Default Access Point:
        SSID: bara
        Password: A7med@Elshab7
        Web Interface: http://192.168.4.1
        
        âš ï¸ LEGAL NOTICE: For educational purposes only!
        
        Note: Using synchronous WebServer (more stable)
        EOF
        
        echo "ðŸ“ Build artifacts collected"

    - name: Upload Firmware Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: bara-esp32-firmware
        path: ${{ env.PROJECT_NAME }}/artifacts/
        retention-days: 30

    - name: Display Build Summary
      run: |
        echo "ðŸŽ‰ Build Completed Successfully!"
        echo "ðŸ“‹ Project: ${{ env.PROJECT_NAME }}"
        echo "ðŸ·ï¸ Version: ${{ env.BUILD_VERSION }}"
        echo "ðŸ“ Artifacts: bara-esp32-firmware"
        echo "ðŸ”§ Board: ESP32 Dev Module"
        echo "ðŸ“Š Firmware: merged_firmware.bin (ready to flash at 0x0)"
        echo "â„¹ï¸  Using synchronous WebServer (stable)"
