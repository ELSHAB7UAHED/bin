name: ESP32 Firmware Builder - bara.cpp

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'bara.cpp'
      - '.github/workflows/builder.yml'
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      build_type:
        description: 'Build Type'
        required: true
        default: 'release'
        type: choice
        options:
          - release
          - debug

env:
  ARDUINO_ESP32_VERSION: '2.0.14'
  PYTHON_VERSION: '3.11'
  ESPTOOL_VERSION: '4.6.2'
  BOARD: 'esp32'
  FLASH_MODE: 'dio'
  FLASH_FREQ: '80m'
  FLASH_SIZE: '4MB'
  PARTITION_SCHEME: 'default'
  BUILD_DIR: 'build'
  OUTPUT_DIR: 'output'

jobs:
  build:
    name: Build ESP32 Firmware
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        board: 
          - esp32
          - esp32s2
          - esp32s3
          - esp32c3
        include:
          - board: esp32
            chip: esp32
            flash_size: 4MB
          - board: esp32s2
            chip: esp32s2
            flash_size: 4MB
          - board: esp32s3
            chip: esp32s3
            flash_size: 8MB
          - board: esp32c3
            chip: esp32c3
            flash_size: 4MB

    steps:
      - name: ðŸ” Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: recursive

      - name: ðŸ Setup Python Environment
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: ðŸ“¦ Install System Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            git \
            wget \
            curl \
            flex \
            bison \
            gperf \
            python3-pip \
            python3-venv \
            cmake \
            ninja-build \
            ccache \
            libffi-dev \
            libssl-dev \
            dfu-util \
            libusb-1.0-0

      - name: ðŸ”§ Install Arduino CLI
        run: |
          curl -fsSL https://raw.githubusercontent.com/arduino/arduino-cli/master/install.sh | sh
          echo "$HOME/bin" >> $GITHUB_PATH

      - name: ðŸ“š Setup Arduino CLI Configuration
        run: |
          arduino-cli config init
          arduino-cli config add board_manager.additional_urls https://raw.githubusercontent.com/espressif/arduino-esp32/gh-pages/package_esp32_index.json
          arduino-cli config set library.enable_unsafe_install true

      - name: ðŸŽ¯ Install ESP32 Board Support
        run: |
          arduino-cli core update-index
          arduino-cli core install esp32:esp32@${{ env.ARDUINO_ESP32_VERSION }}
          arduino-cli core list

      - name: ðŸ“– Install Required Libraries
        run: |
          echo "Installing WiFi libraries..."
          arduino-cli lib install "WiFiManager@2.0.16-rc.2"
          
          echo "Installing WebServer libraries..."
          arduino-cli lib install "WebServer@2.0.0"
          arduino-cli lib install "ESPAsyncWebServer@1.2.3"
          
          echo "Installing AsyncTCP..."
          git clone https://github.com/me-no-dev/AsyncTCP.git ~/Arduino/libraries/AsyncTCP
          
          echo "Installing JSON library..."
          arduino-cli lib install "ArduinoJson@6.21.4"
          
          echo "Installing DNS Server..."
          arduino-cli lib install "DNSServer@1.1.1"
          
          echo "Installing SPIFFS..."
          # SPIFFS is included in ESP32 core
          
          echo "Installing Ticker..."
          # Ticker is included in ESP32 core
          
          echo "Listing installed libraries..."
          arduino-cli lib list

      - name: ðŸ”¨ Create Build Directory Structure
        run: |
          mkdir -p ${{ env.BUILD_DIR }}
          mkdir -p ${{ env.OUTPUT_DIR }}
          mkdir -p sketches/bara
          
          # Copy source file to Arduino sketch directory
          cp bara.cpp sketches/bara/bara.ino
          
          echo "Build directory structure created"
          tree sketches/bara || ls -la sketches/bara

      - name: âš™ï¸ Configure Build Settings
        run: |
          cat > sketches/bara/build.properties << EOF
          compiler.warning_level=all
          build.partitions=${{ env.PARTITION_SCHEME }}
          upload.maximum_size=1310720
          upload.maximum_data_size=327680
          build.defines=-DCORE_DEBUG_LEVEL=0
          EOF
          
          cat sketches/bara/build.properties

      - name: ðŸ—ï¸ Compile Firmware for ${{ matrix.board }}
        run: |
          arduino-cli compile \
            --fqbn esp32:esp32:${{ matrix.board }} \
            --build-property "compiler.warning_level=all" \
            --build-property "build.partitions=default" \
            --output-dir ${{ env.BUILD_DIR }}/${{ matrix.board }} \
            --export-binaries \
            --verbose \
            sketches/bara
          
          echo "âœ… Compilation completed for ${{ matrix.board }}"
          ls -lah ${{ env.BUILD_DIR }}/${{ matrix.board }}/

      - name: ðŸ” Verify Build Output
        run: |
          if [ ! -f "${{ env.BUILD_DIR }}/${{ matrix.board }}/bara.ino.bin" ]; then
            echo "âŒ ERROR: Firmware binary not found!"
            exit 1
          fi
          
          echo "âœ… Firmware binary verified"
          file ${{ env.BUILD_DIR }}/${{ matrix.board }}/bara.ino.bin
          ls -lh ${{ env.BUILD_DIR }}/${{ matrix.board }}/*.bin

      - name: ðŸ Install ESP-IDF Tools
        run: |
          pip install --upgrade pip
          pip install esptool==${{ env.ESPTOOL_VERSION }}
          pip install pyserial
          esptool.py version

      - name: ðŸ”§ Download Bootloader & Partition Files
        run: |
          # Get ESP32 core location
          ESP32_CORE=$(arduino-cli core list | grep esp32:esp32 | awk '{print $NF}')
          echo "ESP32 Core Path: $ESP32_CORE"
          
          # Copy bootloader
          cp "$ESP32_CORE/tools/sdk/esp32${{ matrix.chip == 'esp32' && '' || matrix.chip }}/bin/bootloader_${{ env.FLASH_MODE }}_${{ env.FLASH_FREQ }}.bin" \
             ${{ env.BUILD_DIR }}/${{ matrix.board }}/bootloader.bin || \
          cp "$ESP32_CORE/tools/sdk/${{ matrix.chip }}/bin/bootloader_${{ env.FLASH_MODE }}_${{ env.FLASH_FREQ }}.bin" \
             ${{ env.BUILD_DIR }}/${{ matrix.board }}/bootloader.bin
          
          # Copy partition table
          cp "$ESP32_CORE/tools/partitions/default.bin" \
             ${{ env.BUILD_DIR }}/${{ matrix.board }}/partitions.bin || \
          cp "${{ env.BUILD_DIR }}/${{ matrix.board }}/bara.ino.partitions.bin" \
             ${{ env.BUILD_DIR }}/${{ matrix.board }}/partitions.bin
          
          # Copy boot_app0
          cp "$ESP32_CORE/tools/partitions/boot_app0.bin" \
             ${{ env.BUILD_DIR }}/${{ matrix.board }}/boot_app0.bin || true
          
          echo "âœ… Required binaries copied"
          ls -lah ${{ env.BUILD_DIR }}/${{ matrix.board }}/

      - name: ðŸŽ¯ Create Merged Firmware (merged.bin)
        run: |
          cd ${{ env.BUILD_DIR }}/${{ matrix.board }}
          
          # Merge all binaries into single file at offset 0x0
          python -m esptool \
            --chip ${{ matrix.chip }} \
            merge_bin \
            -o ../../${{ env.OUTPUT_DIR }}/bara_${{ matrix.board }}_merged.bin \
            --flash_mode ${{ env.FLASH_MODE }} \
            --flash_freq ${{ env.FLASH_FREQ }} \
            --flash_size ${{ matrix.flash_size }} \
            0x1000 bootloader.bin \
            0x8000 partitions.bin \
            0xe000 boot_app0.bin \
            0x10000 bara.ino.bin
          
          echo "âœ… Merged firmware created successfully!"
          ls -lh ../../${{ env.OUTPUT_DIR }}/bara_${{ matrix.board }}_merged.bin

      - name: ðŸ“Š Generate Firmware Information
        run: |
          cd ${{ env.OUTPUT_DIR }}
          
          FILESIZE=$(stat -f%z "bara_${{ matrix.board }}_merged.bin" 2>/dev/null || stat -c%s "bara_${{ matrix.board }}_merged.bin")
          MD5SUM=$(md5sum bara_${{ matrix.board }}_merged.bin | awk '{print $1}')
          SHA256SUM=$(sha256sum bara_${{ matrix.board }}_merged.bin | awk '{print $1}')
          
          cat > bara_${{ matrix.board }}_info.txt << EOF
          â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
          â•‘          bara.cpp - ESP32 WiFi Security Testing Tool          â•‘
          â•‘                  Firmware Build Information                    â•‘
          â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          
          ðŸ“¦ Build Details:
          â”œâ”€ Board: ${{ matrix.board }}
          â”œâ”€ Chip: ${{ matrix.chip }}
          â”œâ”€ Date: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          â”œâ”€ Build: ${{ github.run_number }}
          â”œâ”€ Commit: ${{ github.sha }}
          â””â”€ Branch: ${{ github.ref_name }}
          
          ðŸ”§ Configuration:
          â”œâ”€ Flash Mode: ${{ env.FLASH_MODE }}
          â”œâ”€ Flash Frequency: ${{ env.FLASH_FREQ }}
          â”œâ”€ Flash Size: ${{ matrix.flash_size }}
          â”œâ”€ Partition Scheme: ${{ env.PARTITION_SCHEME }}
          â””â”€ Arduino-ESP32: ${{ env.ARDUINO_ESP32_VERSION }}
          
          ðŸ“‚ Binary Information:
          â”œâ”€ Filename: bara_${{ matrix.board }}_merged.bin
          â”œâ”€ Size: $(numfmt --to=iec-i --suffix=B $FILESIZE)
          â”œâ”€ MD5: $MD5SUM
          â””â”€ SHA256: $SHA256SUM
          
          ðŸ“¥ Flash Instructions:
          
          Using esptool.py:
          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          esptool.py --chip ${{ matrix.chip }} \\
                     --port /dev/ttyUSB0 \\
                     --baud 921600 \\
                     write_flash 0x0 bara_${{ matrix.board }}_merged.bin
          
          Using ESP Flash Download Tool:
          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          1. Select chip: ${{ matrix.chip }}
          2. Add file: bara_${{ matrix.board }}_merged.bin @ 0x0
          3. Flash Mode: ${{ env.FLASH_MODE }}
          4. Flash Frequency: ${{ env.FLASH_FREQ }}
          5. Click START
          
          ðŸ“¡ Device Information:
          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          AP Name: bara
          AP Password: A7med@Elshab7
          Admin Password: admin123
          Web Interface: http://192.168.4.1
          
          âš ï¸  Legal Notice:
          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          This tool is for EDUCATIONAL purposes only.
          Always ensure proper authorization before testing any networks.
          Unauthorized access is illegal and unethical.
          
          ðŸ‘¨â€ðŸ’» Developer: Ø£Ø­Ù…Ø¯ Ù†ÙˆØ± Ø£Ø­Ù…Ø¯ Ù…Ù† Ù‚Ù†Ø§
          ðŸ”— Repository: github.com/ELSHAB7UAHED/bin
          
          EOF
          
          cat bara_${{ matrix.board }}_info.txt

      - name: ðŸ“‹ Generate Flash Commands Script
        run: |
          cd ${{ env.OUTPUT_DIR }}
          
          # Linux/Mac flash script
          cat > flash_${{ matrix.board }}.sh << 'EOF'
          #!/bin/bash
          
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘     bara.cpp - ESP32 Firmware Flash Script                    â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          
          PORT=${1:-/dev/ttyUSB0}
          BAUD=${2:-921600}
          
          echo "ðŸ” Checking for esptool.py..."
          if ! command -v esptool.py &> /dev/null; then
              echo "âŒ esptool.py not found. Installing..."
              pip install esptool
          fi
          
          echo "âœ… esptool.py found"
          echo ""
          echo "ðŸ“¡ Flashing firmware to ${{ matrix.board }}..."
          echo "   Port: $PORT"
          echo "   Baud: $BAUD"
          echo ""
          
          esptool.py --chip ${{ matrix.chip }} \
                     --port $PORT \
                     --baud $BAUD \
                     --before default_reset \
                     --after hard_reset \
                     write_flash -z \
                     --flash_mode ${{ env.FLASH_MODE }} \
                     --flash_freq ${{ env.FLASH_FREQ }} \
                     --flash_size ${{ matrix.flash_size }} \
                     0x0 bara_${{ matrix.board }}_merged.bin
          
          if [ $? -eq 0 ]; then
              echo ""
              echo "âœ… Firmware flashed successfully!"
              echo "ðŸ“¡ Device will restart automatically"
              echo "ðŸŒ Connect to WiFi AP: bara"
              echo "ðŸ”‘ Password: A7med@Elshab7"
              echo "ðŸŒ Web Interface: http://192.168.4.1"
          else
              echo ""
              echo "âŒ Flash failed! Please check your connection and try again."
              exit 1
          fi
          EOF
          
          chmod +x flash_${{ matrix.board }}.sh
          
          # Windows flash script
          cat > flash_${{ matrix.board }}.bat << 'EOF'
          @echo off
          echo â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
          echo â•‘     bara.cpp - ESP32 Firmware Flash Script                    â•‘
          echo â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          echo.
          
          set PORT=COM3
          set BAUD=921600
          
          if not "%1"=="" set PORT=%1
          if not "%2"=="" set BAUD=%2
          
          echo ðŸ” Checking for esptool.py...
          where esptool.py >nul 2>nul
          if %ERRORLEVEL% NEQ 0 (
              echo âŒ esptool.py not found. Installing...
              pip install esptool
          )
          
          echo âœ… esptool.py found
          echo.
          echo ðŸ“¡ Flashing firmware to ${{ matrix.board }}...
          echo    Port: %PORT%
          echo    Baud: %BAUD%
          echo.
          
          esptool.py --chip ${{ matrix.chip }} ^
                     --port %PORT% ^
                     --baud %BAUD% ^
                     --before default_reset ^
                     --after hard_reset ^
                     write_flash -z ^
                     --flash_mode ${{ env.FLASH_MODE }} ^
                     --flash_freq ${{ env.FLASH_FREQ }} ^
                     --flash_size ${{ matrix.flash_size }} ^
                     0x0 bara_${{ matrix.board }}_merged.bin
          
          if %ERRORLEVEL% EQU 0 (
              echo.
              echo âœ… Firmware flashed successfully!
              echo ðŸ“¡ Device will restart automatically
              echo ðŸŒ Connect to WiFi AP: bara
              echo ðŸ”‘ Password: A7med@Elshab7
              echo ðŸŒ Web Interface: http://192.168.4.1
          ) else (
              echo.
              echo âŒ Flash failed! Please check your connection and try again.
              exit /b 1
          )
          
          pause
          EOF

      - name: ðŸ“¦ Create Release Package
        run: |
          cd ${{ env.OUTPUT_DIR }}
          
          # Create archive with all files
          tar -czf bara_${{ matrix.board }}_release.tar.gz \
            bara_${{ matrix.board }}_merged.bin \
            bara_${{ matrix.board }}_info.txt \
            flash_${{ matrix.board }}.sh \
            flash_${{ matrix.board }}.bat
          
          zip -9 bara_${{ matrix.board }}_release.zip \
            bara_${{ matrix.board }}_merged.bin \
            bara_${{ matrix.board }}_info.txt \
            flash_${{ matrix.board }}.sh \
            flash_${{ matrix.board }}.bat
          
          echo "âœ… Release packages created"
          ls -lh

      - name: ðŸ“¤ Upload Artifacts - Merged Binary
        uses: actions/upload-artifact@v4
        with:
          name: bara-${{ matrix.board }}-merged-firmware
          path: ${{ env.OUTPUT_DIR }}/bara_${{ matrix.board }}_merged.bin
          retention-days: 90

      - name: ðŸ“¤ Upload Artifacts - Complete Package
        uses: actions/upload-artifact@v4
        with:
          name: bara-${{ matrix.board }}-complete-package
          path: |
            ${{ env.OUTPUT_DIR }}/bara_${{ matrix.board }}_*.tar.gz
            ${{ env.OUTPUT_DIR }}/bara_${{ matrix.board }}_*.zip
          retention-days: 90

      - name: ðŸ“¤ Upload Artifacts - Flash Scripts
        uses: actions/upload-artifact@v4
        with:
          name: bara-${{ matrix.board }}-flash-scripts
          path: |
            ${{ env.OUTPUT_DIR }}/flash_${{ matrix.board }}.sh
            ${{ env.OUTPUT_DIR }}/flash_${{ matrix.board }}.bat
            ${{ env.OUTPUT_DIR }}/bara_${{ matrix.board }}_info.txt
          retention-days: 90

      - name: ðŸ§ª Firmware Analysis
        run: |
          echo "ðŸ“Š Analyzing firmware..."
          python -m esptool --chip ${{ matrix.chip }} image_info ${{ env.OUTPUT_DIR }}/bara_${{ matrix.board }}_merged.bin
          
          echo ""
          echo "ðŸ“¦ Binary sections:"
          python -m esptool --chip ${{ matrix.chip }} dump_mem ${{ env.OUTPUT_DIR }}/bara_${{ matrix.board }}_merged.bin || true

  create-release:
    name: Create GitHub Release
    needs: build
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
      - name: ðŸ” Checkout Repository
        uses: actions/checkout@v4

      - name: ðŸ“¥ Download All Artifacts
        uses: actions/download-artifact@v4
        with:
          path: release-artifacts

      - name: ðŸ·ï¸ Generate Release Tag
        id: tag
        run: |
          TAG="v$(date +%Y%m%d-%H%M%S)"
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "Generated tag: $TAG"

      - name: ðŸ“ Generate Release Notes
        id: release_notes
        run: |
          cat > release_notes.md << 'EOF'
          # ðŸš€ bara.cpp - ESP32 WiFi Security Testing Tool
          
          ## ðŸ“¦ Release Information
          
          **Build Date:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          **Build Number:** ${{ github.run_number }}
          **Commit:** ${{ github.sha }}
          
          ## ðŸŽ¯ Supported Boards
          
          - âœ… ESP32 (4MB Flash)
          - âœ… ESP32-S2 (4MB Flash)
          - âœ… ESP32-S3 (8MB Flash)
          - âœ… ESP32-C3 (4MB Flash)
          
          ## ðŸ“¥ Download & Flash Instructions
          
          ### Quick Flash (Merged Binary - Recommended)
          
          Download the merged binary for your board and flash at offset **0x0**:
```bash
          esptool.py --chip esp32 --port /dev/ttyUSB0 write_flash 0x0 bara_esp32_merged.bin
```
          
          ### Using Flash Scripts
          
          Download and run the flash script for your OS:
          
          **Linux/Mac:**
```bash
          chmod +x flash_esp32.sh
          ./flash_esp32.sh /dev/ttyUSB0 921600
```
          
          **Windows:**
```cmd
          flash_esp32.bat COM3 921600
```
          
          ## ðŸŒ Access Points
          
          After flashing, connect to:
          - **SSID:** bara
          - **Password:** A7med@Elshab7
          - **Web Interface:** http://192.168.4.1
          - **Admin Password:** admin123
          
          ## âš ï¸ Legal Notice
          
          This tool is for **EDUCATIONAL PURPOSES ONLY**.
          - Always ensure proper authorization before testing networks
          - Unauthorized access is illegal and unethical
          - Use responsibly and within legal boundaries
          
          ## ðŸ‘¨â€ðŸ’» Developer
          
          Created by: **Ø£Ø­Ù…Ø¯ Ù†ÙˆØ± Ø£Ø­Ù…Ø¯ Ù…Ù† Ù‚Ù†Ø§**
          
          ## ðŸ“š Features
          
          - ðŸ” WiFi Network Scanning
          - ðŸ“Š Real-time Signal Analysis
          - ðŸ” Security Assessment
          - ðŸ“ˆ Network Statistics
          - ðŸŒ Web-based Interface
          - ðŸ“¡ WebSocket Real-time Updates
          - ðŸ’¾ Data Export (CSV)
          - ðŸŽ¨ Professional Matrix-themed UI
          
          EOF
          
          cat release_notes.md

      - name: ðŸŽ‰ Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.tag.outputs.tag }}
          name: bara.cpp Release ${{ steps.tag.outputs.tag }}
          body_path: release_notes.md
          draft: false
          prerelease: false
          files: |
            release-artifacts/**/*.bin
            release-artifacts/**/*.tar.gz
            release-artifacts/**/*.zip
            release-artifacts/**/*.txt
            release-artifacts/**/*.sh
            release-artifacts/**/*.bat
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  notification:
    name: Build Notification
    needs: [build, create-release]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: ðŸ“¢ Build Success Notification
        if: needs.build.result == 'success'
        run: |
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘                  âœ… BUILD SUCCESSFUL! âœ…                       â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "ðŸŽ‰ bara.cpp firmware built successfully for all boards!"
          echo "ðŸ“¦ Artifacts are ready for download"
          echo "ðŸš€ Check the Actions tab to download your firmware"
          echo ""
          echo "Next steps:"
          echo "1. Download the merged.bin file for your ESP32 board"
          echo "2. Flash using: esptool.py --chip esp32 write_flash 0x0 merged.bin"
          echo "3. Connect to AP 'bara' with password 'A7med@Elshab7'"
          echo "4. Access web interface at http://192.168.4.1"

      - name: ðŸ“¢ Build Failure Notification
        if: needs.build.result == 'failure'
        run: |
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘                   âŒ BUILD FAILED! âŒ                         â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "âŒ bara.cpp firmware build failed!"
          echo "ðŸ“‹ Check the workflow logs for details"
          echo "ðŸ”§ Common issues:"
          echo "   - Missing library dependencies"
          echo "   - Compilation errors in source code"
          echo "   - Arduino-ESP32 core version mismatch"
          exit 1
